<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Agent Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .container, .dashboard-section { background-color: #2a2a2a; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); width: 100%; max-width: 900px; margin-bottom: 30px; }
        h1, h2 { color: #4CAF50; text-align: center; font-weight: 300; margin-top: 0; }
        h1 { margin-bottom: 30px; }
        h2 { border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #bbbbbb; font-size: 0.9em; }
        input[type="url"], select, input[type="datetime-local"] { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #444; border-radius: 5px; background-color: #3a3a3a; color: #e0e0e0; font-size: 1em; box-sizing: border-box; }
        button, .action-btn { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; }
        button:hover, .action-btn:hover { background-color: #45a049; }
        .action-btn { font-size: 0.9em; padding: 8px 12px; margin-right: 5px; }
        .delete-btn { background-color: #c0392b; }
        .delete-btn:hover { background-color: #a93226; }
        .manual-action-btn { background-color: #3498db; width: 48%; margin: 1%; }
        .manual-action-btn:hover { background-color: #2980b9; }
        .status-message { color: #2ecc71; background-color: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #2ecc71; display: none; text-align: center; }
        .error-message { color: #ff6b6b; background-color: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #ff6b6b; display: none; }
        .loading-spinner { border: 4px solid #444; border-top: 4px solid #4CAF50; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #444; word-wrap: break-word; }
        th { background-color: #333; color: #4CAF50; font-weight: 400; }
        td a { color: #66bb6a; text-decoration: none; }
        td a:hover { text-decoration: underline; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #2a2a2a; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: #fff; text-decoration: none; }
        .modal-item { margin-bottom: 15px; word-wrap: break-word; }
        .modal-item strong { color: #bbbbbb; display: block; margin-bottom: 5px; }
        .modal-item pre { background-color: #3a3a3a; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Create New Link</h1>
        <form id="createLinkForm"> <!-- ... form elements from previous steps ... --> </form>
    </div>

    <div class="dashboard-section">
        <h2>Manual Actions</h2>
        <div style="display: flex; justify-content: space-between;">
            <button id="runResearchBtn" class="manual-action-btn">Run Research Now</button>
            <button id="runMarketingBtn" class="manual-action-btn">Process Next Opportunity</button>
        </div>
        <div id="statusMessage" class="status-message"></div>
    </div>

    <div class="dashboard-section">
        <h2>All Links</h2>
        <table id="linksTable"><thead><tr><th>Title</th><th>Trackable URL</th><th>Clicks</th><th>Actions</th></tr></thead><tbody id="linksTableBody"></tbody></table>
    </div>

    <div class="dashboard-section">
        <h2>Latest Research</h2>
        <table id="researchTable"><thead><tr><th>Product Name</th><th>URL</th><th>Discovered At</th><th>Processed</th></tr></thead><tbody id="researchTableBody"></tbody></table>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal"><div class="modal-content"><span class="close-btn details-close">&times;</span><h2>Link Details</h2><div id="modalBody"></div></div></div>

    <!-- Clicks Modal -->
    <div id="clicksModal" class="modal"><div class="modal-content"><span class="close-btn clicks-close">&times;</span><h2>Click History</h2><div id="clicksModalBody"></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing variables ...
            const detailsModal = document.getElementById('detailsModal');
            const clicksModal = document.getElementById('clicksModal');
            const modalBody = document.getElementById('modalBody');
            const clicksModalBody = document.getElementById('clicksModalBody');
            const detailsCloseBtn = document.querySelector('.details-close');
            const clicksCloseBtn = document.querySelector('.clicks-close');

            async function loadAllLinks() {
                try {
                    const response = await fetch('/api/v1/links');
                    if (!response.ok) throw new Error('Failed to load links.');
                    const links = await response.json();
                    const tableBody = document.getElementById('linksTableBody');
                    tableBody.innerHTML = '';
                    links.forEach(link => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).textContent = link.title;
                        const urlCell = row.insertCell(1);
                        const trackableUrl = `${window.location.origin}/track/${link.id}`;
                        const linkElement = document.createElement('a');
                        linkElement.href = trackableUrl; linkElement.textContent = trackableUrl; linkElement.target = '_blank';
                        urlCell.appendChild(linkElement);
                        row.insertCell(2).textContent = link.clickCount;
                        const actionsCell = row.insertCell(3);
                        
                        const detailsBtn = document.createElement('button');
                        detailsBtn.textContent = 'Details';
                        detailsBtn.className = 'action-btn';
                        detailsBtn.onclick = () => showDetails(link.id);
                        actionsCell.appendChild(detailsBtn);

                        const clicksBtn = document.createElement('button');
                        clicksBtn.textContent = 'View Clicks';
                        clicksBtn.className = 'action-btn';
                        clicksBtn.onclick = () => showClicks(link.id);
                        actionsCell.appendChild(clicksBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'action-btn delete-btn';
                        deleteBtn.onclick = () => deleteLink(link.id);
                        actionsCell.appendChild(deleteBtn);
                    });
                } catch (error) { console.error('Error loading links:', error); }
            }

            async function showClicks(linkId) {
                try {
                    const response = await fetch(`/api/v1/links/${linkId}/clicks`);
                    if (!response.ok) throw new Error('Failed to load click history.');
                    const clicks = await response.json();
                    clicksModalBody.innerHTML = ''; // Clear previous content
                    if (clicks.length === 0) {
                        clicksModalBody.innerHTML = '<p>No clicks recorded for this link yet.</p>';
                    } else {
                        const table = document.createElement('table');
                        table.innerHTML = '<thead><tr><th>Click ID</th><th>Timestamp</th></tr></thead>';
                        const tbody = document.createElement('tbody');
                        clicks.forEach(click => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = click.id;
                            row.insertCell(1).textContent = new Date(click.clickedAt).toLocaleString();
                        });
                        table.appendChild(tbody);
                        clicksModalBody.appendChild(table);
                    }
                    clicksModal.style.display = 'block';
                } catch (error) { console.error('Error showing clicks:', error); }
            }

            // ... other functions like loadResearchResults, showDetails, deleteLink, triggerScheduler ...

            // Modal close logic
            detailsCloseBtn.onclick = () => detailsModal.style.display = 'none';
            clicksCloseBtn.onclick = () => clicksModal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == detailsModal) detailsModal.style.display = 'none';
                if (event.target == clicksModal) clicksModal.style.display = 'none';
            };

            // Initial load
            loadAllLinks();
            // loadResearchResults(); // This function needs to be defined from previous steps
        });
    </script>
</body>
</html>